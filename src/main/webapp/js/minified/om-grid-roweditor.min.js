(function(c){var h=Object.prototype.hasOwnProperty,i;c.omWidget.addInitListener("om.omGrid",function(){i=this;var t=i.element,C=i.options,y=C.colModel,B=t.closest(".om-grid"),x=c(".hDiv thead tr:first th",B),s,z;i._triggered=false;i._globalEditable=false;C.editMode=C.editMode||"all";i._allEditMode=C.editMode=="all";for(var v=0,w=y.length;v<w;v++){i._globalEditable=y[v]["editor"]?true:false;if(i._globalEditable){break}}if(!f()){return}i._editComps={};i._errorHolders={};i._colWidthResize;C._onRefreshCallbacks.push(p);C._omResizableCallbacks.push(g);this.tbody.delegate("tr.om-grid-row","dblclick",A);this.tbody.delegate("tr.om-grid-row","click",function(D){if(i._triggered&&i._editView.editing){if(i._validator&&i._validator.valid()){A.call(this)}else{A.call(this)}}});var u;t.parent().scroll(function(){if(i._triggered){if(u){clearTimeout(u)}u=setTimeout(function(){var D=r();i._editView.editBtn.animate({left:D.left,top:D.top},i._editView.editing?"fast":0);u=null},300)}});c.extend(c.om["omGrid"].prototype,{cancleEdit:function(D){var E=i._editView;if(!f()||!i._triggered||(i._triggered&&!E.editing)){return}E.view.hide();E.editing=false;o();D&&c(D).blur()},cancleChanges:function(){if(!f()||!e()){return}i._changeData={update:{},insert:{},"delete":{}};o();i.refresh()},editRow:function(D){if(!f()){return}A.call(i._getTrs().eq(D)[0])},deleteRow:function(D){if(!f()){return}var E=i._getTrs().eq(D);i.cancleEdit();var F=a(E);if(E.attr("_insert")){delete i._changeData.insert[F];E.remove()}else{i._changeData["delete"][F]=i._rowIdDataMap[F];E.attr("_delete","true");E.hide()}},getChanges:function(H){var J={update:[],insert:[],"delete":[]},D=H?H:"update",F=i._changeData,G;if(D==="update"){var E=F[D];for(G in E){h.call(E,G)&&J[D].push(c.extend(true,{},i._rowIdDataMap[G],E[G]))}D=H?H:"insert"}if(D==="insert"){var I=F[D];for(G in I){h.call(I,G)&&J[D].push(I[G])}D=H?H:"delete"}if(D==="delete"){var K=F[D];for(G in K){h.call(K,G)&&J[D].push(K[G])}}if(H){return J[H]}else{return J}},insertRow:function(J,G){if(!f()){return}if(c.isPlainObject(J)){G=J;J=0}var E=i._getTrs();J=("begin"==J||J==undefined)?0:("end"==J?E.length:J);var M={};for(var H=0,K=y.length;H<K;H++){M[y[H]["name"]]=""}i._changeData.insert[i._guid]=c.extend(true,M,G);var L=i._buildRowCellValues(y,M,J),D=[],F=C.rowClasses;isRowClassesFn=(typeof F==="function"),rowCls=isRowClassesFn?F(J,M):F[J%F.length],tdTmp="<td align='$' abbr='$' class='grid-cell-dirty $'><div align='$' class='$' style='width:$px'>$</div></td>";D.push("<tr class='om-grid-row "+rowCls+"' _grid_row_id="+(i._guid++)+" _insert='true'>");c(x).each(function(Q){var S=c(this).attr("axis"),R=false,P,T,O;if(S=="indexCol"){P="<a class='om-icon'>新行</a>"}else{if(S=="checkboxCol"){P='<span class="checkbox"/>'}else{if(S.substring(0,3)=="col"){var N=S.substring(3);P=L[N];if(y[N].wrap){R=true}}else{P=""}}}T=[this.align,this.abbr,S,this.align,R?"wrap":"",c("div",c(this)).width(),P];O=0;D.push(tdTmp.replace(/\$/g,function(){return T[O++]}))});D.push("</tr>");var I=c(D.join(" "));J==0?I.prependTo(t.find(">tbody")):E.eq(J-1).after(I);i.editRow(J)},saveChanges:function(){if(!f()||!e()){return}var G=i._changeData,F=i.pageData.data.rows,E=G.update,J=G["delete"],D=i.element.find("tr.om-grid-row"),I=[];for(var H in E){if(h.call(E,H)){c.extend(true,i._rowIdDataMap[H],E[H])}}D.each(function(K,M){var L=c(M);if(L.attr("_delete")){L.remove()}else{I.push(q(M))}});i.pageData.data.rows=I;i._changeData={update:{},insert:{},"delete":{}};o();i.refresh()},getData:function(){var D=this.pageData.data,E=i._getTrs();if(f()&&e()){D={total:D.total};D.rows=[];E.each(function(F,G){D.rows.push(i._getRowData(F))})}return D},_getRowData:function(E){var G=this._getTrs().eq(E),I=a(G),H;if(G.attr("_insert")){H=i._changeData.insert[I]}else{var F=i._rowIdDataMap[I],D=i._changeData.update;H=F;if(D[I]){H=c.extend(true,{},F,D[I])}}return H}});function A(){var E=c(this),G,D,F;if(!f()){return}if(!i._allEditMode&&!E.attr("_insert")){return}if(i._triggered&&i._editView.editing&&a(E)==i._editView.rowId){return}m(this);G=i._editView.editRow;D=G.find(">.grid-edit-form");F=t.parent().scrollLeft();c(x).each(function(O){var J=c(this).attr("axis"),L,R=E.find("td:eq("+O+")"),H,T;if(J.substring(0,3)=="col"){var S=J.substring(3);L=y[S]}else{if(c.isEmptyObject(i._editComps)){G.css("padding-left",parseInt(G.css("padding-left"))+R.outerWidth())}return}var N=L.editor;if(!i._triggered){if(!N||(N&&(N.editable===false||(c.isFunction(N.editable)&&N.editable()===false)))){var P=N&&N.renderer;L.editor=N={};N.type="text";if(P){N.renderer=P;N.type="custom"}N.editable=false}else{N.type=N.type||"text";N.editable=true;if(N.rules){i._validate=true}}T=L.editor.name||L.name;N.options=N.options||{};i._editComps[T]={}}else{T=L.editor.name||L.name}s=i._editComps[T];z=k(E,L)||"";if(!i._triggered&&N.editable&&N.rules){i._errorHolders[T]=c("<div class='errorContainer' style='display:none'></div>").appendTo(t.parent())}var I=s.instance,M,Q=N.type;if(!I){M=c("<div style='position:absolute'></div>").css({left:R.position().left+F,top:3}).appendTo(D).addClass("grid-edit-wrapper");I=s.instance=c("<input></input>").attr({name:T,id:T}).appendTo(M);if("text"!=Q&&"custom"!=Q){I[Q](N.options)}if("omCalendar"==Q||"omCombo"==Q){var K=I.parent();if("omCalendar"==Q){I.val(z).width(R.outerWidth()-24)}I.width(R.outerWidth(true)-(K.outerWidth(true)-I.width()))}else{if("text"==Q){I.addClass("grid-edit-text");if(!N.editable){I.attr("readonly","readonly").addClass("readonly-text")}}if("custom"==Q){M.html(N.renderer(z))}I.width(R.outerWidth(true)-(I.outerWidth(true)-I.width()))}s.model=L;s.type=Q;s.id=L.name}switch(Q){case"omCalendar":I=I.val(z).omCalendar();break;case"omNumberField":I.val(z).trigger("blur");break;case"omCombo":I.omCombo("value",z);break;case"text":I.val(z);break;default:}});!i._triggered&&i._validate&&l();i._validator&&i._validator.form();i._triggered=true}});function r(){var s=i.element,u=s.parent(),v=i._editView,w=v.view,t=v.editBtn,y=v.editRow,x={};x.top=y.height();if(s.width()<u.width()){x.left=t.parent().width()/2-t.width()/2}else{x.left=u.scrollLeft()+u.width()/2-t.width()/2}return x}function p(){if(f()){this._changeData={"delete":{},insert:{},update:{}};n(this);if(i._triggered){o();i._editView.view.hide();i._editView.editing=false;i.hDiv.scrollLeft(0);i.element.parent().scrollLeft(0)}}}function f(){return !i._allEditMode||i._globalEditable}function n(){var s=i.getData().rows;i._rowIdDataMap={};i._getTrs().each(function(t,u){i._rowIdDataMap[a(u)]=s[t]})}function o(){if(i._validator){i._validator.resetForm();c.each(i._errorHolders,function(s,t){t.empty()})}}function e(){var s=i._changeData;return !(c.isEmptyObject(s.update)&&c.isEmptyObject(s.insert)&&c.isEmptyObject(s["delete"]))}function m(y){var s=i.element,B=s.next(".grid-edit-view"),A,x,u=c(y).position();if(B.length==0){B=c("<div class='grid-edit-view'><div class='body-wrapper'><div class='grid-edit-row'><form class='grid-edit-form'></form></div><div class='gird-edit-btn'><input type='button' class='ok' value='保存'/><input type='button' class='cancle' value='取消'/></div></div></div>").width(s.outerWidth()).insertAfter(s);A=B.find(".gird-edit-btn"),x=A.prev(".grid-edit-row"),z;i._editView={view:B,editRow:x,editBtn:A};z=r();A.css({left:z.left,top:z.top});var w=A.find("input.ok").omButton(),v=A.find("input.cancle").omButton();w.click(function(){if(i._validator&&!i._validator.form()){return}b(s.find("tr[_grid_row_id='"+i._editView.rowId+"']"));B.hide();i._editView.editing=false;w.blur()});v.click(function(){i.cancleEdit(this)})}i._editView.rowId=a(y);if(i._editView.editing){B.animate({top:u.top},"fast")}else{B.css({top:u.top});i._editView.editing=true;B.show();if(i._colWidthResize){var t=s.parent().scrollLeft();A=B.find(".gird-edit-btn");B.width(s.outerWidth());i.hDiv.find("th[axis^=col]").each(function(C,E){var F=c(E).attr("abbr"),D=c(E);c.each(i._editComps,function(H,G){var J=G.instance,I=G.type;if(F==G.id){J.closest("div.grid-edit-wrapper").width(D.outerWidth()).css("left",D.position().left+t);if("omCalendar"==I||"omCombo"==I){var K=J.parent();if("omCalendar"==I){J.width(D.outerWidth()-24)}J.width(D.outerWidth(true)-(K.outerWidth(true)-J.width()))}else{J.width(D.outerWidth(true)-(J.outerWidth(true)-J.width()))}}})});var z=r();A.css({left:z.left,top:z.top});i._colWidthResize=false}}}function g(t,x){if(!f()||!this._triggered||!this._editView.editing){this._colWidthResize=true;return}var u=i._editView;$editView=u.view,$editBtn=u.editBtn;$editView.width(i.element.outerWidth());var s=i.hDiv.find("th"),v=true;i.hDiv.find("th:gt("+(s.index(t)-1)+")").each(function(y,A){var B=c(A).attr("abbr"),z=c(A);c.each(i._editComps,function(D,C){var F=C.instance,E=C.type;if(B==C.id){if(!v){F.closest("div.grid-edit-wrapper").css("left","+="+x)}if(v){if("omCalendar"==E||"omCombo"==E){var G=F.parent();if("omCalendar"==E){F.width(z.outerWidth()-24)}F.width(z.outerWidth(true)-(G.outerWidth(true)-F.width()))}else{F.width(z.outerWidth(true)-(F.outerWidth(true)-F.width()))}}v=false}})});var w=r();$editBtn.animate({left:w.left,top:w.top},"fast")}function b(v){var t=c(v),y=i._editView.editRow,x=i._editComps,w=a(t),s=i._getTrs().index(t),u=i._getRowData(s);c.each(x,function(B,A){var D=A.model.name,F=d(t,A),z,C,E;if(t.attr("_insert")){i._changeData.insert[w][D]=F}else{z=q(v)[D];E=i._changeData.update[w];if(F==z){j(t,A.model,false);E&&delete E[D];c.isEmptyObject(E)&&delete i._changeData.update[w]}else{j(t,A.model,true);E=i._changeData.update[w]=E||{};E[D]=F}}if(A.model.renderer){C=A.model.renderer(F,u,s)}else{C=F?F:""}t.find("td[abbr='"+D+"'] >div").html(C)})}function j(u,t,s){u.find("td[abbr='"+t.name+"']").toggleClass("grid-cell-dirty",s)}function a(s){return c(s).attr("_grid_row_id")}function d(t,s){var v,u=q(t);switch(s.type){case"omCalendar":v=s.instance.val();case"omNumberField":v=s.instance.val();break;case"omCombo":v=s.instance.omCombo("value");break;case"text":v=s.instance.val();break;default:break}return v}function k(v,u){var w,t=u.name;if(v.attr("_insert")){w=q(v)[t]}else{var s=i._changeData.update[a(v)];if(s&&s[t]!=null){w=s[t]}else{w=q(v)[t]}}return w}function q(s){var t=a(s);return c(s).attr("_insert")?i._changeData.insert[t]:i._rowIdDataMap[t]}function l(){var s=i._editView.editRow.find(">.grid-edit-form"),v={},w=v.rules={},u=v.messages={},t=i.options.colModel;c.each(t,function(D,B){var C=B.editor.rules;if(C){var x=w[B.editor.name||B.name]={},z=u[B.editor.name||B.name]={};if(C.length>0&&!c.isArray(C[0])){var F=[];F.push(C);C=F}for(var A=0,E=C.length;A<E;A++){var y=C[A][0];x[y]=C[A][1]==undefined?true:C[A][1];if(C[A][2]){z[y]=C[A][2]}}}});c.extend(v,{onkeyup:function(x){this.element(x)},errorPlacement:function(x,y){},showErrors:function(z,A){if(A&&A.length>0){c.each(A,function(F,H){var D=c(H.element),E=D.attr("name");var G=i._errorHolders[E];if(G){var C=D.offset(),B=i.element.offset();G.css({left:C.left-B.left+D.outerWidth(),top:C.top-B.top+D.outerHeight()}).html(H.message);if(D.is(":focus")){G.show()}}})}else{c.each(this.currentElements,function(B,C){var D=i._errorHolders[c(C).attr("name")];D&&D.empty().hide()})}var x=i._editView.editBtn.find("input.ok"),y=true;c.each(i._errorHolders,function(B,C){if(!C.is(":empty")){return y=false}});y?x.omButton("enable"):x.omButton("disable");this.defaultShowErrors()}});i._validator=s.validate(v);c.each(i._editComps,function(y,x){var A=x.model.editor;if(A.editable&&A.rules){var z=A.name||x.model.name,B=i._errorHolders[z];x.instance.mouseover(function(){if(B&&!B.is(":empty")){B.show()}}).mouseout(function(){B&&B.hide()})}})}})(jQuery);