(function(a){a.omWidget("om.omMenu",{options:{contextMenu:false,maxWidth:200,minWidth:100,dataSource:"local"},show:function(b){var i=this,j=i.options,g,c,e=i.element;var d=a(b).offset();if(j.contextMenu){g=b.pageY;c=b.pageX;b.preventDefault();b.stopPropagation();b.cancelBubble=true}else{var f=parseInt(a(b).css("borderBottomWidth").replace("px",""));g=d.top+a(b).height()+(f!="NaN"?f:0)+1;c=d.left+1}var h=e.parent();while(h.css("position")=="static"&&h[0].nodeName!="BODY"){h=h.parent()}g-=h.offset().top;c-=h.offset().left;if((c+e.outerWidth())>document.documentElement.clientWidth){c=c-e.outerWidth()-20}a(e).css({top:g,left:c}).show();a(e).children("ul.om-menu").show();a(e).children("ul.om-menu").children().each(function(l,k){if(a(k).find("span:first").hasClass("om-menu-item-sep")){a(k).find("span:first").width("98%")}else{var m=a(e).width()*0.7;if(a(k).find("span:first").width()>m){a(k).find("span:first").width(a(k).attr("aria-haspopup")?m-15:m)}}})},hide:function(){this._hide()},disableItem:function(b){this.element.find("#"+b).addClass("om-state-disabled").unbind(".menuItem")},enableItem:function(e){var c=this,d=c.element;var b=d.find("#"+e);b.removeClass("om-state-disabled");c._bindLiEvent(b)},destroy:function(){var c=a(document),b;while(b=this.globalEvent.pop()){c.unbind(".omMenu",b)}},_create:function(){var c=this,d=c.options,f=c.element,e=d.dataSource;f.addClass("om-menu-container om-menu-content om-corner-all");f.css("position","absolute");if(e){if(e!="local"){if(typeof e=="string"){c._ajaxLoad(f,e)}else{if(typeof e=="object"){f.append(c._appendNodes.apply(c,[e]));c._bindEvent()}}}else{var b=f.children("ul").addClass("om-menu");c._parseDomMenu(b);c._bindEvent()}}},_init:function(){var b=this.options,c=this.element;c.css({minWidth:b.minWidth,maxWidth:b.maxWidth-10});if(a.browser.msie&&a.browser.version=="6.0"){c.css("width",b.minWidth+30)}if(a.browser.msie&&a.browser.version=="7.0"){c.css("width",b.maxWidth-10)}},_ajaxLoad:function(d,c){var b=this;a.ajax({url:c,method:"POST",dataType:"json",success:function(e){d.append(b._appendNodes.apply(b,[e]));b._bindEvent()}})},_appendNodes:function(h,d){var b=this,c=[];var f=(d==undefined)?"om-menu":"om-menu-content";var i=(d==undefined)?"block":"none";var e=(d==undefined)?"om-menu-icon":"om-menu-icon om-menu-icon-child";c.push('<ul class="'+f+' om-corner-all" style="display:'+i+';">');var g=[];a(h).each(function(k,l){if(l.children!=null){if(l.disabled===true||l.disabled=="true"){g.push('<li id="'+l.id+'" aria-haspopup="true"  class="om-state-disabled">')}else{g.push('<li id="'+l.id+'"  aria-haspopup="true">')}g.push('<a href="javascript:void(0)" class="om-corner-all om-menu-indicator">');l.icon?g.push('<img class="'+e+'" src="'+l.icon+'">'):null;l.icon?g.push("<span>"+l.label+"</span>"):g.push('<span style="margin-left:2em;">'+l.label+"</span>");g.push('<span class="ui-icon-span" role="popup"></span>');g.push("</a>");g.push(b._appendNodes(l.children,k++));g.push("</li>")}else{if(l.disabled===true||l.disabled=="true"){g.push('<li id="'+l.id+'"  class="om-state-disabled">')}else{g.push('<li id="'+l.id+'" >')}g.push('<a href="javascript:void(0)" class="om-corner-all om-menu-indicator">');l.icon?g.push('<img class="'+e+'" src="'+l.icon+'">'):null;l.icon?g.push("<span>"+l.label+"</span>"):g.push('<span style="margin-left:2em;">'+l.label+"</span>");g.push("</a>");g.push("</li>")}if(l.seperator=="true"||l.seperator==true){g.push('<li class="om-menu-sep-li"  ><span class="om-menu-item-sep">&nbsp;</span></li>')}var j=a(b.element).attr("id")+"_"+l.id;a(b.element).data(j,l)});c.push(g.join(""));c.push("</ul>");return c.join("")},_parseDomMenu:function(f){if(f.parent().attr("aria-haspopup")=="true"){f.addClass("om-menu-content om-corner-all")}f.css("display","none");var d=f.children();for(var e=0;e<d.length;e++){var b=a(d[e]),c=b.children("ul");if(c.length>0){b.attr("aria-haspopup","true");b.find("span[role='popup']").addClass("ui-icon-span");this._parseDomMenu(c)}b.find("a").addClass("om-corner-all om-menu-indicator");b.find("img").addClass("om-menu-icon")}},_showChildren:function(b){var c=this;if(b&&b.length>0){var e=b.children("ul").eq(0);e.css({minWidth:this.options.minWidth,top:b.position().top});var d=b.width();if((2*d+b.offset().left)>document.documentElement.clientWidth){d=-d}e.css("left",d);e.show();e.children().each(function(g,f){if(a(f).find("span:first").hasClass("om-menu-item-sep")){a(f).find("span:first").width("98%")}else{if(e.width()>c.options.maxWidth){e.width(c.options.maxWidth);width=c.options.maxWidth*0.6}else{e.width(e.width()+10);width=e.width()*0.6}a(f).find("span:first").width(width)}})}},_hideChildren:function(b){b.children("ul").eq(0).hide()},_bindLiEvent:function(b){var c=this,e=c.element,d=c.options;a(b).bind("mouseenter.menuItem",function(){var f=a(this);f.addClass("om-menu-item-hover");if(f.attr("aria-haspopup")){setTimeout(function(){c._showChildren(f)},200)}}).bind("mouseleave.menuItem",function(){var f=a(this);f.removeClass("om-menu-item-hover");setTimeout(function(){f.children("ul").hide()},200)}).bind("mousedown.menuItem",function(g){var f=a(e).data(a(e).attr("id")+"_"+this.id);if(d.onSelect){c._trigger("onSelect",g,f);g.preventDefault();g.stopPropagation();g.cancelBubble=true}})},_bindEvent:function(){var k=this,e=k.element,l=k.options,g=e.find("ul"),h=e.find("li"),d=a(document),b;for(var f=0;f<h.length;f++){if(!a(h[f]).hasClass("om-state-disabled")){k._bindLiEvent(h[f])}}for(var c=0;c<g.length;c++){a(g[c]).bind("mouseleave.menuContainer",function(){var i=a(this);if(i.parent().attr("aria-haspopup")=="true"){i.hide()}})}this.globalEvent=[];d.bind("mousedown.omMenu",b=function(){k._hide()});this.globalEvent.push(b);d.bind("keyup.omMenu",b=function(j){var i=j.keyCode,m=a.om.keyCode;switch(i){case m.DOWN:k._selectNext();break;case m.UP:k._selectPrev();break;case m.LEFT:k._hideRight();break;case m.RIGHT:k._showRight();break;case m.ENTER:if(e.css("display")=="block"){k._backfill(e)}break;case m.ESCAPE:k._hide();break;default:null}});this.globalEvent.push(b);d.bind("keydown.omMenu",b=function(i){if(i.keyCode>=37&&i.keyCode<=40){i.preventDefault()}});this.globalEvent.push(b)},_hide:function(){var b=this,c=b.element;c.find("ul").css("left","none");c.find("li.om-menu-item-hover").each(function(d,e){a(e).removeClass("om-menu-item-hover")});c.hide()},_findNext:function(b){var c,e=b;while((c=b.next("li")).length!==0){if(!c.hasClass("om-menu-sep-li")&&!c.hasClass("om-state-disabled")){return c}b=c}var d=e.parent().find("li:first");while(d.length!==0&&d!=e){if(!d.hasClass("om-menu-sep-li")&&!d.hasClass("om-state-disabled")){return d}d=d.next("li")}},_findPrev:function(b){var e,f=b;while((e=b.prev("li")).length!==0){if(!e.hasClass("om-menu-sep-li")&&!e.hasClass("om-state-disabled")){return e}b=e}var d=f.parent().children();var c=d.eq(d.length-1);while(c.length!==0&&c!=f){if(!c.hasClass("om-menu-sep-li")&&!c.hasClass("om-state-disabled")){return c}c=c.prev("li")}},_selectNext:function(){var c=this,d=c.element,f;var b=d.find("li.om-menu-item-hover");var e=b.eq(b.length-1);if(b.length==0){f=d.find("li").eq(0);while(f.hasClass("om-state-disabled")){f=f.next("li")}f.addClass("om-menu-item-hover")}else{f=c._findNext(e);if(f.length<=0){return}f.addClass("om-menu-item-hover");e.removeClass("om-menu-item-hover")}this._hideChildren(e);this._showChildren(f)},_selectPrev:function(){var c=this,e=c.element,g;var b=e.find("li.om-menu-item-hover");var f=b.eq(b.length-1);g=e.find("ul.om-menu > li");if(b.length==0){var h=g.eq(g.length-1),d=1;while(h.hasClass("om-state-disabled")){h=g.eq(g.length-(d++))}(g=h).addClass("om-menu-item-hover")}else{g=c._findPrev(f);if(g.length<=0){return}g.addClass("om-menu-item-hover");f.removeClass("om-menu-item-hover")}this._hideChildren(f);this._showChildren(g)},_hideRight:function(){var b=this,d=b.element;var c=d.find("li.om-menu-item-hover"),e=c.eq(c.length-1);e.removeClass("om-menu-item-hover");b._hideChildren(e)},_showRight:function(){var c=this,d=c.element,f;var e=d.find("li.om-menu-item-hover"),b=e.eq(e.length-1);if(b.attr("aria-haspopup")=="true"){f=b.children("ul").find("li").eq(0);f.addClass("om-menu-item-hover")}c._showChildren(f)},_backfill:function(b){var c=b.find("li.om-menu-item-hover");c.eq(c.length-1).mousedown()}})})(jQuery);